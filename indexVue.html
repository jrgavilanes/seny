<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>Seny: Gestión documental para grupos.</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.1/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
  <!-- <link rel="stylesheet" href="/css/markdown.css"> -->
  <!-- <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/skeleton.css"> -->
  <link rel="stylesheet" href="/css/mi-markdown.css">
  <style>
    @media print {
      .no-print,
      .no-print * {
        display: none !important;
      }
    }
    .tag {
      margin: .2em;
      cursor: pointer;
    }
    /* https://www.w3schools.com/cssref/css_default_values.asp */
    .block {
      margin: 1em;
    }
    .hero {
      margin-bottom: 1em;
    }
    .invisible {
      display: none;
    }
    .card {
      margin-bottom: 1em;
    }
    .floatButton {
      position: fixed;
      width: 60px;
      height: 60px;
      bottom: 20px;
      right: 20px;
      background-color: rgba(10, 50, 255, 0.9);
      color: #FFF;
      border-radius: 50px;
      text-align: center;
      vertical-align: middle;
      box-shadow: 2px 2px 3px #999;
    }
    .notificacion {
      position: fixed;
      z-index: 1000;
      top: 40px;
      right: 40px;
    }
  </style>
</head>

<body>

  <div id="app">

    <div v-show="estado === 'login'">

      <section class="hero is-info">
        <div class="hero-body">
          <div class="container">
            <h1 class="title">
              <i class="fa fa-hand-spock-o" aria-hidden="true"></i>
              <i>Seny</i>
            </h1>
            <h2 class="subtitle" style="margin-top: .1em;">
              Control de acceso
            </h2>
          </div>
        </div>
      </section>

      <div class="container">

        <div class="columns">
          
          <div class="column"></div>
          
          <div class="column is-4">
            
            <div class="block">
              <div class="field">
                <label class="label">Usuario</label>
                <div class="control">
                  <input v-model="usuario" @keyup.enter="validar()" class="input" type="text" placeholder="Usuario">
                </div>
              </div>
            </div>

            <div class="block">
              <div class="field">
                <label class="label">Password</label>
                <div class="control">
                  <input type="password" @keyup.enter="validar()" v-model="password" class="input" type="text" placeholder="Password">
                </div>
              </div>
            </div>

            <div class="block">
              <p class="control is-pulled-right">
                <a id="guardar-mensaje-btn" class="button is-info" @click="validar()">
                  Validar
                </a>
              </p>
            </div>

          </div>
          
          <div class="column"></div>
          
        </div>
        

        
        
      </div>
      <!-- container -->

    </div>
    <!-- Login -->

    <div v-show="estado === 'showAll'">

      <section class="hero is-info">
        <div class="hero-body">
          <div class="container">
            <h1 class="title">
              <a @click="showAll()" title="Mostrar todos los documentos">
                <i class="fa fa-hand-spock-o" aria-hidden="true"></i>
                <i>Seny</i>
              </a>
            </h1>
            <h2 class="subtitle" style="margin-top: .1em;">
              <div class="field has-addons">
                <div class="control">
                  <input v-model="buscador" class="input" type="text" placeholder="Encontrar documento">
                </div>
                <div class="control">
                  <a class="button is-warning">
                    Buscar
                  </a>
                </div>
              </div>
            </h2>
            <a @click="logout()" title="Salir">Cerrar sesión @{{usuario}}</a>
          </div>
        </div>
      </section>

      <div class="container">

        <div class="block" id="tablon">
          <div v-for="registro in vista" class="card">
            <header class="card-header">
              <p class="card-header-title">
                <a title="Abrir documento" @click="getDocument(registro.titulo)">[#{{registro.id}}] {{registro.titulo}}</a>
              </p>
              <a href="#" v-show="registro.autor=='@'+usuario" class="card-header-icon" aria-label="more options">
                <span class="icon" title="Editar documento" @click="editDocument(registro.titulo)">
                  <i class="fa fa-pencil is-size-4" aria-hidden="true"></i>
                </span>
              </a>
            </header>
            <div class="card-content">
              <div class="content">
                <span class="is-pulled-left" style="font-size: .8em;">
                  <a title="Mostrar documentos de este autor" @click="filter(registro.autor)">{{registro.autor}}</a>
                </span>
                <span class="is-pulled-right" style="font-size: .8em;"><em>Creado {{moment(registro.createdAt,"YYYY-MMDD h:mm").fromNow()}}</em></span>
                <br>
                <strong>
                  <em>Síntomas:</em>
                </strong>
                <br>
                <div style="margin-left: 2em;" v-html="SimpleMDE.prototype.markdown(registro.sintomas)"></div>

                <br>
                <span class="is-pulled-right" style="font-size: .8em;"><em>Última actualización {{moment(registro.updatedAt,"YYYY-MMDD h:mm").fromNow()}}</em></span>
                <hr> 
                <a @click="filter(tag)" v-for="tag in registro.etiquetas.split(', ')">{{tag}} </a>


                <br>

              </div>
            </div>
            <!-- <footer class="card-footer">
                  <a href="#" class="card-footer-item"><span style="font-size: 1em; margin-right: .4em;">0 </span> <i class="fa fa-thumbs-up is-size-4" aria-hidden="true"></i></a>
                  <a href="#" class="card-footer-item"><span style="font-size: 1em; margin-right: .4em;">0 </span> <i class="fa fa-commenting is-size-4" aria-hidden="true"></i></a>
                </footer> -->
          </div>
        </div>

        <a id="getDocumentos_add" class="floatButton" @click="createDocument()">
          <i class="fa fa-plus" style="margin-top: 1em; font-size: 1.3em;"></i>
        </a>

      </div>
      <!-- container -->

    </div>
    <!-- showAll -->


    <div v-show="estado === 'upsertDocument'">

      <section class="hero is-info">
        <div class="hero-body">
          <div class="container">
            <h1 class="title">
              <i class="fa fa-hand-spock-o" aria-hidden="true"></i>
              <i>Seny</i>
            </h1>
            <h2 class="subtitle" style="margin-top: .1em;">
              {{titulo_ventana}}
            </h2>
            <a @click="logout()">Desconectar @{{usuario}}</a>
          </div>
        </div>
      </section>

      <div class="container">
        
         

        <div class="block" style="margin-top: 1em;">
          
          <div v-show="titulo_ventana==='Editar documento'">[#{{registro_actual.id}}]</div>
          <button v-show="titulo_ventana==='Editar documento' && registro_actual.autor=='@'+usuario" title="Borrar documento" class="delete is-pulled-right" @click="deleteRecord(registro_actual.id, '@'+usuario)"></button>
          
          
          <div class="field">
            <label class="label">Qué soluciona este documento? *</label>
            <div class="control">
              <input v-model="registro_actual.titulo" class="input" type="text" name="titulo" id="titulo" placeholder="Nombre del documento"
                required>
            </div>
          </div>
        </div>
        <div class="block">
          <div class="field">
            <label class="label">Tiene alguna incidencia relacionada?</label>
            <div class="control">
              <input v-model="registro_actual.incidencias" class="input" type="text" name="indicencias" id="indicencias" placeholder="Códigos de incidencias relacionadas">
            </div>
          </div>
        </div>
        <div class="block">
          <label class="label">Clasifica el documento *</label>
          <div class="box">
            <div class="field">

              <div class="control">
                <input v-model="registro_actual.etiquetas" class="input" type="text" id="etiquetas" name="etiquetas" placeholder="etiqueta1, etiqueta2"
                  required>
              </div>
            </div>

            <i>Etiquetas existentes: </i>

            <div id="etiquetero">
              <span v-for="tag in tags" class="tag is-warning" style="margin: .5em;" @click="addTag(tag)">{{tag}}</span>
            </div>


          </div>
        </div>
        <div class="block">
          <label class="label">Síntomas *</label>
          <sintomas name='sintomas'></sintomas>
        </div>
        <div class="block">
          <label class="label">Procedimiento *</label>
          <procedimiento name='procedimiento'></procedimiento>

        </div>

        <div class="block">
          <div class="level is-mobile">
            <div class="level-left">
              <p class="control">
                <a id="cancelar-mensaje-btn" class="button is-blue" @click="questionExitFromInsert()">
                  Salir
                </a>
              </p>
            </div>

           
            <div class="level-right">
              <p class="control">
                <a id="guardar-mensaje-btn" class="button is-info" @click="upsertRecord()">
                  Guardar
                </a>
              </p>
            </div>
          </div>
        </div>

      </div>
      <!-- container -->

    </div>
    <!-- upsertDocument -->


    <div v-show="estado=='showDocument'">

      <section class="hero is-info no-print">
        <div class="hero-body">
          <div class="container">
            <h1 class="title">
              <a @click="showAll()" title="Volver">
                <i class="fa fa-hand-spock-o" aria-hidden="true"></i>
                <i>Seny</i>
              </a>
            </h1>
            <h2 class="subtitle" style="margin-top: .1em;">
              Mostrar documento
            </h2>
            Hola {{usuario}}! <a @click="logout()">Cerrar sesión</a>
          </div>
        </div>
      </section>

      <div class="container">



        <div id="markdown" style="margin: .5em;">



          <strong>
            <span class="is-size-4">Título: </span>
          </strong>
          [#{{registro_actual.id}}] {{registro_actual.titulo}}
          <br>
          <strong>
            <span class="is-size-4">Incidencia/s: </span>
          </strong>
          {{registro_actual.incidencias}}
          <br>
          <strong>
            <span class="is-size-4">Etiqueta/s: </span>
          </strong>
          {{registro_actual.etiquetas}}
          <br>
          <strong>
            <span class="is-size-4">Síntomas: </span>
          </strong>
          <div style="margin-top: .5em;" v-html="SimpleMDE.prototype.markdown(registro_actual.sintomas)"></div>
          <strong>
            <span class="is-size-4">Procedimiento: </span>
          </strong>
          <div style="margin-top: .5em;" v-html="SimpleMDE.prototype.markdown(registro_actual.procedimiento)"></div>

        </div>
        <!-- markdown -->

        <br>
        <p class="control" style="margin: .5em;">
          <a class="button is-warning no-print" @click="showAll()">
            Volver atrás
          </a>
        </p>
        
        
        <div class="block no-print">
          <hr>
          <div class="field">
            <label class="label">¿Tienes algo que decir?</label>
            
            <textarea class="textarea" v-model="comentario" placeholder="Escribe tu comentario"></textarea>
            
          </div>
          <p v-show="comentario.trim()!=''" class="control is-pulled-right" style="margin: .5em;">
            <a class="button is-info no-print" @click="insertComment()">
              Enviar comentario
            </a>
            
          </p>        
          
          <br><br>
        
          <div v-show="registro_actual.comentarios.length>0" class="is-size-4">COMENTARIOS</div>

          <div v-for="comentario in registro_actual.comentarios" class="notification no-print is-blue" style="margin: 1em; ">
            <button v-show="'@'+usuario == comentario.autor" class="delete" @click="deleteComment(comentario.id)"></button>
            <p>de <strong>{{comentario.autor}}</strong> {{moment(comentario.createdAt,"YYYY-MMDD h:mm").fromNow()}}</p>
            {{comentario.mensaje}}
          </div>

      </div>
        
      

      </div>
      <!-- container -->

    </div>
    <!-- showDocument -->

    <!-- modales -->

    <div v-if="errorMessage!==''" class="modal is-active" id="msgBox" @click="errorMessage=''">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Error</p>
          <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
          <div style="margin-left: 2em;" v-html="errorMessage"></div>
        </section>
      </div>
    </div>

    <div v-if="notificacion!==''" class="notification notificacion is-link">
      <!-- <button class="delete"></button> -->
      <div v-html="notificacion"></div>
    </div>

    <div v-if="confirmacion!==''" class="modal is-active">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Ventana de confirmación</p>
          <button class="delete" aria-label="close" @click="confirmacion=''"></button>
        </header>
        <section class="modal-card-body">
          <div v-html="confirmacion"></div>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-success" @click="exitFromInsert()">Salir</button>
          <button class="button" @click="confirmacion=''">Cancelar</button>
        </footer>
      </div>
    </div>

    <!-- fin-modales -->



  </div>
  <!-- app -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/locale/es.js"></script>
  <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.4/lodash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script>
    // <!-- <editor-wapo name='sintomas'></editor-wapo> -->

    moment.locale('es');
    // console.log(moment().format().substr(0,19).replace("T", " "));

    //2018-02-04T19:35:28



    let myGlobal = {};
    Vue.component('sintomas', {
      template: `<textarea id="sintomas" cols="30" rows="10" required placeholder='Cuándo lo hago?'></textarea>`,
      props: ['name'],
      mounted() {
        myGlobal[this.name] = new SimpleMDE({ element: document.getElementById('sintomas'), spellChecker: false });
      }
    });
    Vue.component('procedimiento', {
      template: `<textarea id='procedimiento' cols='30' rows='10' required placeholder='Cómo lo hago?'></textarea>"`,
      props: ['name'],
      mounted() {
        myGlobal[this.name] = new SimpleMDE({ element: document.getElementById(this.name), spellChecker: false });
      }
    });
    // estados: [showAll|upsertDocument|showDocument|login]
    let App = new Vue({
      el: '#app',
      data: {
        estado: 'showAll',
        errorMessage: '',
        notificacion: '',
        confirmacion: '',
        titulo_ventana: '',
        registroHash: '',
        buscador: '',
        usuario: '',
        password: '',
        comentario: '',
        registro_actual: {
          id: -1,
          titulo: '',
          incidencias: '',
          etiquetas: '',
          sintomas: '',
          procedimiento: '',
          comentarios: [],
          autor: ''
        },
        tags: ["mga", "silo", "recepcion", "otro", "ay"],
        registros: [
          {
            "id": 1000,
            "incidencias": "17R06396",
            "sintomas": "- Pasillos del Silo parados.\n- La paleta de entrada actual no corresponde con la paleta que físicamente está esperando.",
            "procedimiento": "Para quitar una orden del pulmón de entrada de un trasolo ( y que las otras se muevan a una posición), hay que conectarse al servidor:\n\n```\nrdona.es\n```\n\nAcceder con nuestro propio usuario y posteriormente conectarse a urgentes:\n\n```\nsuo -i -u ures\n. j-ir.sh alp\ncd incilo\nebp\n```\n\n",
            "titulo": "Cancelar orden de entrada SILO",
            "etiquetas": "#mga, #otra-cosa",
            "autor": "@a",
            "comentarios": [
              {
                "id": 1,
                "autor": "@nano",
                "mensaje": "pues mola mogollón",
                "createdAt":  "2017-07-23 13:45"
              },
              {
                "id": 2,
                "autor": "@nana",
                "mensaje": "pues eso es bla bla bla",
                "createdAt":  "2017-07-23 13:45"
              }
              
            ],
            "createdAt": "2017-07-23 13:45",
            "updatedAt": "2017-07-23 13:45"
            
          },
          {
            "id": 1001,
            "incidencias": "17R06396",
            "sintomas": "- Pasillos del Silo parados.\n- La paleta de entrada actual no corresponde con la paleta que físicamente está esperando.",
            "procedimiento": "Para quitar una orden del pulmón de entrada de un trasolo ( y que las otras se muevan a una posición), hay que conectarse al servidor:\n\n```\nridona.es\n```\n\nAcceder con nuestro propio usuario y posteriormente conectarse a urgentes:\n\n```\nsuo -i -u urtes\n. j-ir.sh alp\ncd inci_si\nedp\n```\n\n",
            "titulo": "Cancelar orden de entrada SILO 2",
            "etiquetas": "#silo",
            "autor": "@a",
            "comentarios": [
              {
                "id": 1,
                "autor": "@xx",
                "mensaje": "pues mola mogollón",
                "createdAt":  "2017-07-23 13:45"
              },
              {
                "id": 2,
                "autor": "@ter",
                "mensaje": "pues eso es bla bla bla",
                "createdAt":  "2017-07-23 13:45"
              }
              
            ],
            "createdAt": "2017-07-24 13:45",
            "updatedAt": "2017-07-24 13:45"
          },
          {
            "id": 1002,
            "incidencias": "17R06396",
            "sintomas": "- Pasillos del Silo parados.\n- La paleta de entrada actual no corresponde con la paleta que físicamente está esperando.",
            "procedimiento": "Para quitar una orden del pulmón de entrada de un trasolo ( y que las otras se muevan a una posición), hay que conectarse al servidor:\n\n```\nribna.es\n```\n\nAcceder con nuestro propio usuario y posteriormente conectarse a urgentes:\n\n```\nsdo -i -u urtes\n. j-ir.sh alp\ncd ini_sio\nedp\n```\n\n",
            "titulo": "Cancelar orden de entrada SILO 3",
            "etiquetas": "#recepcion",
            "comentarios": [],
            "autor": "@jrgavilanes",
            "createdAt": "2017-07-25 13:45",
            "updatedAt": "2017-07-25 13:45"
          }
        ]
      },
      mounted(){
        this.tags = this.tags.sort();

        if (this.password !== this.usuario || this.password === '') {
          this.estado = 'login';
        }

      },
      computed: {
        vista: function () {
          //Trabajar más el buscador.
          if (this.buscador !== '') {

            let busca = this.buscador;
            busca = busca.toLowerCase().trim().split(" ");


            let filtro = _.filter(this.registros, function (o) {

              //return o.titulo.toLowerCase().includes(busca.toLowerCase());
              //return ''.concat(o.id,o.titulo,o.autor,o.etiquetas,o.incidencias,o.sintomas,o.procedimiento).toLowerCase().includes(busca.toLowerCase());

              let chivato = busca.length;

              for (let i = 0; i<busca.length; i++) {

                if ( ''.concat('#'+o.id,o.titulo,o.autor,o.etiquetas,o.incidencias,o.sintomas,o.procedimiento).toLowerCase().includes(busca[i])) chivato--;

              }

              return chivato === 0;


            });

            return _.orderBy(filtro, ['id'], ['desc']);

          } else {

            return _.orderBy(this.registros, ['id'], ['desc']);

          }
        }
      },
      methods: {
        insertComment(){
          
          let x = this.registro_actual.id;
          
          let i = _.findIndex(this.registros, function(o) { return o.id == x; });
          
          
          let myComentario = {};   
                    
          try {
            myComentario.id = _.maxBy(this.registros[i].comentarios, 'id').id;
          } catch(e) {
            myComentario.id = 0;
          }     
          
          myComentario.id++;
          
          
          myComentario.mensaje = this.comentario;
          myComentario.createdAt = this.now();
          myComentario.autor = '@'+this.usuario;
          
          
          this.registros[i].comentarios.push(myComentario);
          this.registro_actual.comentarios.push(myComentario);
          
          this.comentario = "";
          
          
        },
        deleteComment(id){
          
           if (confirm("¿Deseas borrar el comentario?")) {
             
             let x = this.registro_actual.id;

             let i = _.findIndex(this.registros, function(o) { return o.id == x; });

             x = _.findIndex(this.registros[i].comentarios, function(o) { return o.id == id; });

             this.registros[i].comentarios.splice(x,1);

             this.registro_actual.comentarios.splice(x,1);
             
           }     
          
        },
        now(){
          return moment().format().substr(0,19).replace("T", " ");
        },
        logout() {
          this.usuario = "";
          this.password = "";
          this.estado = "login";
        },
        validar(){
          if (this.password === this.usuario && this.password !== '') {
            this.estado = 'showAll';
          } else {
            this.errorMessage = '<li>Usuario no válido</li>';
          }
        },
        addTag(tag) {
          if (this.registro_actual.etiquetas === '') {
            this.registro_actual.etiquetas += tag;
          } else {
            this.registro_actual.etiquetas += ", " + tag;
          }
        },
        filter(filtro){
          this.buscador = filtro;
        },
        deleteRecord(id, usuario) {

          if (confirm("¿Deseas borrar el documento?")) {

            let id_registro = _.findIndex(this.registros, function(o) { return o.id == id && o.autor == usuario; });

            if (id_registro>=0) {             
              this.registros.splice(id_registro, 1);
              this.showAll();
            }  
          }


        },
        upsertRecord() {

          let reg = {};
          //limpia etiquetas
          this.registro_actual.etiquetas = this.registro_actual.etiquetas.trim();
          this.registro_actual.etiquetas = this.registro_actual.etiquetas.replace(/,$/, ""); //quito la última coma si existe.

          let aux = _.split(this.registro_actual.etiquetas, ",");
          aux = _.map(aux, _.trim);
          aux = _.map(aux, _.toLower);
          aux = aux.map((e) => {
            return _.replace(e, / +/g, "-");
          });
          aux = _.uniq(aux);
          let tags = aux;
          this.registro_actual.etiquetas = tags.join(", ");


          //Comprueba campos


          if (this.registro_actual.titulo === '') {
            this.errorMessage = '<li>Titulo no puede estar vacío</li>';
          }
          if (this.registro_actual.etiquetas === '') {
            this.errorMessage += '<li>Las etiquetas no pueden estar vacias</li>';
          }
          if (myGlobal.sintomas.value() === '') {
            this.errorMessage += '<li>El campo de síntomas no puede estar vacío</li>';
          }
          if (myGlobal.procedimiento.value() === '') {
            this.errorMessage += '<li>El campo de procedimiento no puede estar vacío</li>';
          }



          if (this.errorMessage === '') {
            //Actualizo tabla tags
            this.tags = _.union(this.tags, tags);
            this.tags = _.sortedUniq(this.tags);
            this.tags = this.tags.sort();


            //console.log(this.tags);
            aux = "#" + aux.join(", #");
            aux = aux.trim()
            //this.registro_actual.etiquetas = aux;


            if (this.titulo_ventana === 'Crear documento') {

              // El titulo ha de ser único en la BD
              let t = this.registro_actual.titulo;
              let i = _.findIndex(this.registros, function(o) { return o.titulo == t; });

              if (i>=0) {
                this.errorMessage += '<li>Ya existe un documento con el mismo título</li>';
              } else {
                reg.etiquetas = aux;
                reg.titulo = this.registro_actual.titulo;
                reg.incidencias = this.registro_actual.incidencias;
                reg.sintomas = myGlobal.sintomas.value();
                reg.procedimiento = myGlobal.procedimiento.value();
                reg.autor = "@"+this.usuario;
                reg.createdAt = this.now();
                reg.updatedAt = this.now();


                reg.id = _.maxBy(this.registros, 'id').id + 1;
                this.registro_actual.id = reg.id;
                this.registros.push(reg);


                this.titulo_ventana = 'Editar documento';

                this.notificacion = 'El documento ha sido creado correctamente.';
                setTimeout(() => {
                  this.notificacion = '';
                }, 2000);

              }          

            } else {

              let id_registro = this.registro_actual.id;
              id_registro = _.findIndex(this.registros, function(o) { return o.id == id_registro; });
              this.registros[id_registro].etiquetas = aux;
              this.registros[id_registro].titulo = this.registro_actual.titulo;
              this.registros[id_registro].incidencias = this.registro_actual.incidencias;
              this.registros[id_registro].sintomas = myGlobal.sintomas.value();
              this.registros[id_registro].procedimiento = myGlobal.procedimiento.value();
              this.registros[id_registro].updatedAt = this.now();

              this.notificacion = 'El documento ha sido editado correctamente.';
              setTimeout(() => {
                this.notificacion = '';
              }, 2000);

            }
          }

          this.registroHash = this.registro_actual.titulo +
            this.registro_actual.incidencias +
            this.registro_actual.etiquetas +
            myGlobal.sintomas.value() +
            myGlobal.procedimiento.value();

        },
        questionExitFromInsert() {
          if (this.titulo_ventana === 'Crear documento') {
            if (this.registro_actual.titulo !== '' ||
              this.registro_actual.etiquetas !== '' ||
              this.registro_actual.incidencias !== '' ||
              myGlobal.sintomas.value() !== '' ||
              myGlobal.procedimiento.value() !== ''
            ) {
              this.confirmacion = "¿Deseas salir sin guardar cambios?";
            } else {
              this.exitFromInsert();
            }
          }
          if (this.titulo_ventana === 'Editar documento') {
            if (this.registroHash !== this.registro_actual.titulo +
              this.registro_actual.incidencias +
              this.registro_actual.etiquetas +
              myGlobal.sintomas.value() +
              myGlobal.procedimiento.value()
            ) {
              this.confirmacion = "¿Deseas salir sin guardar cambios?";
            } else {
              this.exitFromInsert();
            }
          }
        },
        exitFromInsert() {
          this.registro_actual.titulo = '';
          this.registro_actual.etiquetas = '';
          this.registro_actual.incidencias = '';
          myGlobal.sintomas.value("");
          myGlobal.procedimiento.value("");
          this.confirmacion = '';
          this.buscador='';
          this.estado = 'showAll';
          this.topScroll();
        },
        showAll(){
          this.estado = '';
          this.buscador = '';
          this.comentario = '';
          setTimeout(() => {
            this.estado='showAll';
            this.topScroll();
          }, 10);      
        },
        showTags(tags){
          tags = tags.split(", ");
          let salida = "";
          for (let i = 0; i<tags.length; i++) {

            salida += ` <a @click="alert($(tags[i]))">$(tags[i])</a>`;

          }

          return salida;

        },
        getDocument(title) {

          this.topScroll();

          let i = _.findIndex(this.registros, function(o) { return o.titulo == title; });

          if (i >= 0) {

            this.registro_actual.id = this.registros[i].id;
            this.registro_actual.titulo = this.registros[i].titulo;
            this.registro_actual.incidencias = this.registros[i].incidencias;
            this.registro_actual.etiquetas = this.registros[i].etiquetas;
            this.registro_actual.sintomas = this.registros[i].sintomas;
            this.registro_actual.procedimiento = this.registros[i].procedimiento;
            this.registro_actual.autor = this.registros[i].autor;
            
            this.registro_actual.comentarios = [];
            
            for (let ii = 0; ii< this.registros[i].comentarios.length; ii++) {
              //console.log(this.registro_actual.comentarios);
              //console.log(this.registros[i].comentarios[ii]);
              this.registro_actual.comentarios.push(this.registros[i].comentarios[ii]);
            }
                        

            this.estado = 'showDocument';  

          }

        },
        editDocument(title) {

          this.topScroll();

          let i = _.findIndex(this.registros, function(o) { return o.titulo == title; });

          if (i >= 0) {

            this.registro_actual.id = this.registros[i].id;
            this.registro_actual.titulo = this.registros[i].titulo;
            this.registro_actual.incidencias = this.registros[i].incidencias;
            this.registro_actual.etiquetas = this.registros[i].etiquetas.replace(/#/g, "");
            this.registro_actual.sintomas = this.registros[i].sintomas;
            this.registro_actual.procedimiento = this.registros[i].procedimiento;
            this.registro_actual.autor = this.registros[i].autor;

            myGlobal.sintomas.value(this.registro_actual.sintomas);
            myGlobal.procedimiento.value(this.registro_actual.procedimiento);
            setTimeout(() => {
              myGlobal.sintomas.codemirror.refresh();
              myGlobal.procedimiento.codemirror.refresh();
            }, 100);

            this.titulo_ventana = "Editar documento"
            this.estado = 'upsertDocument';

            this.registroHash = this.registro_actual.titulo +
              this.registro_actual.incidencias +
              this.registro_actual.etiquetas +
              myGlobal.sintomas.value() +
              myGlobal.procedimiento.value();

          } else {


            this.errorMessage += '<li>Documento no encontrado</li>';


          }


        },
        createDocument() {
          this.topScroll();
          
          myGlobal.sintomas.value("");
          myGlobal.procedimiento.value("");
          setTimeout(() => {
              myGlobal.sintomas.codemirror.refresh();
              myGlobal.procedimiento.codemirror.refresh();
          }, 100);
          
          this.registro_actual.id = -1;
          this.registro_actual.titulo = "";
          this.registro_actual.incidencias = "";
          this.registro_actual.etiquetas = "";
          this.registro_actual.sintomas = "";
          this.registro_actual.procedimiento = "";
          this.titulo_ventana = "Crear documento"
          this.estado = 'upsertDocument';

        },
        topScroll() {
          document.body.scrollTop = 0; // For Safari
          document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
        }
      }
    });
  </script>

</body>

</html>